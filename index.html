<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رواية Soon</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* متغيرات الألوان الأساسية */
        :root {
            --primary-color: #f47521; 
            --dark-bg: #23252b;
            --darker-bg: #191b1f;
            --light-text: #ffffff;
            --gray-text: #9fadbd;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', Arial, sans-serif;
        }

        body {
            background-color: var(--darker-bg);
            color: var(--light-text);
            direction: rtl;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .save-btn {
            background-color: var(--primary-color);
            color: var(--light-text);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: var(--transition);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .save-btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }

        .novel-container {
            display: flex;
            gap: 20px;
        }

        .sidebar {
            width: 250px;
            background-color: var(--dark-bg);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .arcs-list {
            list-style: none;
        }

        .arc-item {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray-text);
        }

        .arc-item:hover, .arc-item.active {
            background-color: var(--primary-color);
            color: var(--light-text);
        }

        .arc-name {
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .arc-name::after {
            content: "▾";
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .arc-item.active .arc-name::after {
            transform: rotate(180deg);
        }

        .chapters-list {
            list-style: none;
            margin-top: 10px;
            display: none;
            padding-right: 10px;
            border-right: 2px solid var(--primary-color);
            margin-right: 5px;
        }

        .arc-item.active .chapters-list {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chapter-item {
            padding: 8px 15px;
            margin: 5px 0;
            background-color: var(--darker-bg);
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .chapter-item:hover, .chapter-item.active {
            background-color: var(--primary-color);
            opacity: 0.8;
            transform: translateX(-5px);
        }

        .content {
            flex: 1;
            background-color: var(--dark-bg);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .novel-viewer {
            width: 100%;
            height: 550px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .image-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .novel-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .novel-image:hover {
            transform: scale(1.02);
        }

        .navigation-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: var(--light-text);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            transition: var(--transition);
            opacity: 0.7;
        }

        .navigation-btn:hover {
            background-color: var(--primary-color);
            opacity: 1;
            width: 50px;
            height: 50px;
        }

        .prev-btn {
            left: 10px;
        }

        .next-btn {
            right: 10px;
        }

        .info-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .info-content {
            background-color: var(--dark-bg);
            border-radius: 10px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--primary-color);
            padding-bottom: 10px;
        }

        .info-title {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--light-text);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-btn:hover {
            color: var(--primary-color);
            transform: rotate(90deg);
        }

        .info-details {
            margin-bottom: 15px;
        }

        .info-item {
            margin-bottom: 15px;
        }

        .info-item span:first-child {
            color: var(--primary-color);
            font-weight: bold;
            display: inline-block;
            margin-left: 5px;
        }

        .info-description {
            line-height: 1.7;
            color: var(--gray-text);
            margin-top: 10px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .toast.active {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }

        .image-counter {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--light-text);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 5;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .controls-hint {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--gray-text);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 5;
        }

        .content:hover .controls-hint {
            opacity: 1;
        }

        /* تجاوبية */
        @media (max-width: 900px) {
            .novel-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }

            .novel-viewer {
                height: 450px;
            }
        }

        @media (max-width: 480px) {
            .novel-viewer {
                height: 350px;
            }

            .navigation-btn {
                width: 35px;
                height: 35px;
            }

            .header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Soon رواية</div>
            <button class="save-btn" id="saveBtn">حفظ في المفضلة</button>
        </header>

        <div class="novel-container">
            <div class="sidebar">
                <ul class="arcs-list" id="arcsList">
                    <!-- سيتم إنشاء الأركات هنا ديناميكيًا -->
                </ul>
            </div>

            <div class="content">
                <div class="novel-viewer" id="novelViewer">
                    <div class="image-container">
                        <img src="" alt="صورة الرواية" class="novel-image" id="novelImage">
                        <div class="image-counter" id="imageCounter">0/0</div>
                        <div class="controls-hint" id="controlsHint">نقرتين: نسخ الرابط | ضغط مطول: معلومات الرواية</div>
                    </div>
                    <button class="navigation-btn prev-btn" id="prevBtn">&#10094;</button>
                    <button class="navigation-btn next-btn" id="nextBtn">&#10095;</button>
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="info-modal" id="infoModal">
        <div class="info-content">
            <div class="info-header">
                <div class="info-title" id="infoTitle">عنوان الرواية</div>
                <button class="close-btn" id="closeInfoBtn">&times;</button>
            </div>
            <div class="info-details">
                <div class="info-item"><span>الكاتب:</span> <span id="infoAuthor">-</span></div>
                <div class="info-item"><span>عدد الفصول:</span> <span id="infoChaptersCount">-</span></div>
                <div class="info-item"><span>الوصف:</span> <div id="infoDescription" class="info-description">-</div></div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">تم نسخ الرابط بنجاح!</div>

    <script>
        // بيانات الرواية
        const novelData = {
            title: "Soon",
            author: "كاتب القصة",
            description: "وصف للرواية حيث يتم سرد أحداث مثيرة ومشوقة تجذب القارئ من البداية للنهاية. تتناول الرواية قضايا مختلفة وتأخذك في رحلة مليئة بالمفاجآت والانعطافات غير المتوقعة التي ستبقيك متشوقاً لمعرفة المزيد.",
            arcs: [
                {
                    id: 1,
                    name: "الموسم الأول",
                    chapters: [
                        { id: 1, title: "البداية", images: 16 },
                        { id: 2, title: "المواجهة", images: 16 },
                        { id: 3, title: "الصدمة", images: 16 }
                    ]
                },
                {
                    id: 2,
                    name: "الموسم الثاني",
                    chapters: [
                        { id: 4, title: "العودة", images: 16 },
                        { id: 5, title: "الانتقام", images: 16 },
                        { id: 6, title: "الحقيقة", images: 16 }
                    ]
                },
                {
                    id: 3,
                    name: "الموسم الثالث",
                    chapters: [
                        { id: 7, title: "النهاية", images: 16 },
                        { id: 8, title: "البداية الجديدة", images: 16 }
                    ]
                }
            ]
        };

        // عناصر DOM
        const arcsList = document.getElementById('arcsList');
        const novelImage = document.getElementById('novelImage');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const saveBtn = document.getElementById('saveBtn');
        const imageCounter = document.getElementById('imageCounter');
        const infoModal = document.getElementById('infoModal');
        const closeInfoBtn = document.getElementById('closeInfoBtn');
        const infoTitle = document.getElementById('infoTitle');
        const infoAuthor = document.getElementById('infoAuthor');
        const infoChaptersCount = document.getElementById('infoChaptersCount');
        const infoDescription = document.getElementById('infoDescription');
        const toast = document.getElementById('toast');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const controlsHint = document.getElementById('controlsHint');

        // متغيرات الحالة
        let currentArcId = null;
        let currentChapterId = null;
        let currentImageIndex = 0;
        let longPressTimer;
        let isSaved = false;
        let isLoading = false;

        // تحميل المحفوظات
        function loadSavedState() {
            const savedNovel = localStorage.getItem('savedNovel');
            if (savedNovel) {
                try {
                    const saved = JSON.parse(savedNovel);
                    if (saved.title === novelData.title) {
                        isSaved = true;
                        updateSaveButton();
                    }
                } catch (error) {
                    console.error('خطأ في تحليل البيانات المحفوظة:', error);
                    localStorage.removeItem('savedNovel');
                }
            }
        }

        // تحديث زر الحفظ
        function updateSaveButton() {
            if (isSaved) {
                saveBtn.textContent = 'إزالة من المفضلة';
                saveBtn.style.backgroundColor = 'var(--gray-text)';
            } else {
                saveBtn.textContent = 'حفظ في المفضلة';
                saveBtn.style.backgroundColor = 'var(--primary-color)';
            }
        }

        // إنشاء قائمة الأركات
        function renderArcs() {
            arcsList.innerHTML = '';
            novelData.arcs.forEach(arc => {
                const arcItem = document.createElement('li');
                arcItem.className = 'arc-item';
                arcItem.dataset.id = arc.id;
                
                let arcHTML = `
                    <div class="arc-name">${arc.name}</div>
                    <ul class="chapters-list">
                `;
                
                arc.chapters.forEach(chapter => {
                    arcHTML += `<li class="chapter-item" data-arc-id="${arc.id}" data-chapter-id="${chapter.id}">${chapter.title}</li>`;
                });
                
                arcHTML += `</ul>`;
                arcItem.innerHTML = arcHTML;
                arcsList.appendChild(arcItem);

                // إضافة مستمع الحدث للنقر على الأرك
                arcItem.querySelector('.arc-name').addEventListener('click', function() {
                    const isActive = arcItem.classList.contains('active');
                    
                    document.querySelectorAll('.arc-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    if (!isActive) {
                        arcItem.classList.add('active');
                        currentArcId = arc.id;
                    }
                });
            });

            // إضافة مستمعات الأحداث للفصول
            document.querySelectorAll('.chapter-item').forEach(chapterItem => {
                chapterItem.addEventListener('click', function() {
                    const arcId = parseInt(this.dataset.arcId);
                    const chapterId = parseInt(this.dataset.chapterId);
                    
                    document.querySelectorAll('.chapter-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    loadChapter(arcId, chapterId);
                });
            });
        }

        // تحميل فصل معين
        function loadChapter(arcId, chapterId) {
            const arc = novelData.arcs.find(a => a.id === arcId);
            if (!arc) return;
            
            const chapter = arc.chapters.find(c => c.id === chapterId);
            if (!chapter) return;
            
            currentArcId = arcId;
            currentChapterId = chapterId;
            currentImageIndex = 0;
            
            // حفظ الحالة الحالية مباشرة إذا كانت الرواية محفوظة
            if (isSaved) {
                saveCurrentState();
            }
            
            loadImage();
        }

        // عرض واجهة التحميل
        function showLoading() {
            isLoading = true;
            loadingOverlay.style.display = 'flex';
            novelImage.style.opacity = '0.5';
        }

        // إخفاء واجهة التحميل
        function hideLoading() {
            isLoading = false;
            loadingOverlay.style.display = 'none';
            novelImage.style.opacity = '1';
        }

        // تحميل صورة معينة من الفصل الحالي
        function loadImage() {
            if (!currentArcId || !currentChapterId) {
                novelImage.src = '';
                imageCounter.textContent = '0/0';
                return;
            }
            
            showLoading();
            
            const arc = novelData.arcs.find(a => a.id === currentArcId);
            const chapter = arc.chapters.find(c => c.id === currentChapterId);
            
            // محاكاة تحميل الصورة
            const newImage = new Image();
            newImage.onload = function() {
                novelImage.src = this.src;
                hideLoading();
                imageCounter.textContent = `${currentImageIndex + 1}/${chapter.images}`;
                updateNavigationButtons();
            };
            
            newImage.onerror = function() {
                hideLoading();
                showToast('فشل في تحميل الصورة');
                novelImage.alt = 'فشل في تحميل الصورة';
            };
            
            // في بيئة حقيقية، هنا سنقوم بتحميل صورة حقيقية من مصدر البيانات
            newImage.src = `https://via.placeholder.com/600x800?text=الفصل+${chapter.title}+صورة+${currentImageIndex + 1}`;
        }

        // تحديث أزرار التنقل (التالي/السابق)
        function updateNavigationButtons() {
            if (!currentArcId || !currentChapterId) {
                prevBtn.style.visibility = 'hidden';
                nextBtn.style.visibility = 'hidden';
                return;
            }
            
            const arc = novelData.arcs.find(a => a.id === currentArcId);
            const chapter = arc.chapters.find(c => c.id === currentChapterId);
            
            prevBtn.style.visibility = currentImageIndex > 0 ? 'visible' : 'hidden';
            nextBtn.style.visibility = currentImageIndex < chapter.images - 1 ? 'visible' : 'hidden';
        }

        // الانتقال للصورة السابقة
        function goToPreviousImage() {
            if (isLoading) return;
            
            if (currentImageIndex > 0) {
                currentImageIndex--;
                loadImage();
                
                // حفظ الحالة الحالية مباشرة إذا كانت الرواية محفوظة
                if (isSaved) {
                    saveCurrentState();
                }
            }
        }

        // الانتقال للصورة التالية
        function goToNextImage() {
            if (isLoading) return;
            
            const arc = novelData.arcs.find(a => a.id === currentArcId);
            const chapter = arc.chapters.find(c => c.id === currentChapterId);
            
            if (currentImageIndex < chapter.images - 1) {
                currentImageIndex++;
                loadImage();
                
                // حفظ الحالة الحالية مباشرة إذا كانت الرواية محفوظة
                if (isSaved) {
                    saveCurrentState();
                }
            } else {
                // إذا كنا في نهاية الفصل، ننتقل إلى الفصل التالي إن وجد
                const currentChapterIndex = arc.chapters.findIndex(c => c.id === currentChapterId);
                if (currentChapterIndex < arc.chapters.length - 1) {
                    // الانتقال إلى الفصل التالي في نفس الأرك
                    const nextChapter = arc.chapters[currentChapterIndex + 1];
                    loadChapter(currentArcId, nextChapter.id);
                    
                    // تحديث واجهة المستخدم
                    document.querySelectorAll('.chapter-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    document.querySelector(`.chapter-item[data-arc-id="${currentArcId}"][data-chapter-id="${nextChapter.id}"]`).classList.add('active');
                } else {
                    // ابحث عن الأرك التالي إن وجد
                    const currentArcIndex = novelData.arcs.findIndex(a => a.id === currentArcId);
                    if (currentArcIndex < novelData.arcs.length - 1) {
                        const nextArc = novelData.arcs[currentArcIndex + 1];
                        const firstChapterInNextArc = nextArc.chapters[0];
                        
                        // تحديث واجهة المستخدم
                        document.querySelectorAll('.arc-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        document.querySelector(`.arc-item[data-id="${nextArc.id}"]`).classList.add('active');
                        
                        loadChapter(nextArc.id, firstChapterInNextArc.id);
                        
                        // تحديث واجهة المستخدم للفصل
                        document.querySelectorAll('.chapter-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        document.querySelector(`.chapter-item[data-arc-id="${nextArc.id}"][data-chapter-id="${firstChapterInNextArc.id}"]`).classList.add('active');
                    }
                }
            }
        }

        // عرض معلومات الرواية
        function showNovelInfo() {
            infoTitle.textContent = novelData.title;
            infoAuthor.textContent = novelData.author;
            
            // حساب إجمالي عدد الفصول والصور
            const totalChapters = novelData.arcs.reduce((total, arc) => total + arc.chapters.length, 0);
            const totalImages = novelData.arcs.reduce((total, arc) => {
                return total + arc.chapters.reduce((chTotal, ch) => chTotal + ch.images, 0);
            }, 0);
            
            infoChaptersCount.textContent = `${totalChapters} (${totalImages} صورة)`;
            infoDescription.textContent = novelData.description;
            
            infoModal.style.display = 'flex';
        }

        // إخفاء معلومات الرواية
        function hideNovelInfo() {
            infoModal.style.display = 'none';
        }

        // حفظ الحالة الحالية
        function saveCurrentState() {
            if (!currentArcId || !currentChapterId) return;
            
            const savedData = {
                title: novelData.title,
                arcId: currentArcId,
                chapterId: currentChapterId,
                imageIndex: currentImageIndex,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('savedNovel', JSON.stringify(savedData));
        }

        // نسخ رابط المشاركة
        function copyShareLink() {
            if (!currentArcId || !currentChapterId) return;
            
            // في بيئة حقيقية، يمكن إنشاء رابط مشاركة حقيقي
            const shareLink = `https://example.com/novel/soon?arc=${currentArcId}&chapter=${currentChapterId}&image=${currentImageIndex}`;
            
            navigator.clipboard.writeText(shareLink)
                .then(() => {
                    showToast('تم نسخ الرابط بنجاح!');
                })
                .catch(err => {
                    showToast('حدث خطأ في نسخ الرابط');
                    console.error('حدث خطأ في نسخ الرابط:', err);
                });
        }

        // عرض إشعار
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('active');
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, 2000);
        }

        // حفظ الرواية في المفضلة أو إزالتها
        function toggleSave() {
            if (isSaved) {
                localStorage.removeItem('savedNovel');
                isSaved = false;
                showToast('تم إزالة الرواية من المفضلة');
            } else {
                if (!currentArcId || !currentChapterId) {
                    showToast('يرجى اختيار فصل أولاً');
                    return;
                }
                
                saveCurrentState();
                isSaved = true;
                showToast('تم حفظ الرواية في المفضلة');
            }
            
            updateSaveButton();
        }

        // التعامل مع ضغطات المفاتيح
        function handleKeyPress(e) {
            // السهم الأيمن للصورة السابقة (في واجهة RTL)
            if (e.key === 'ArrowRight') {
                goToPreviousImage();
            }
            // السهم الأيسر للصورة التالية (في واجهة RTL)
            else if (e.key === 'ArrowLeft') {
                goToNextImage();
            }
            // ESC لإغلاق النوافذ المنبثقة
            else if (e.key === 'Escape') {
                hideNovelInfo();
            }
        }

        // مستمعات الأحداث
        function setupEventListeners() {
            // أزرار التنقل
            prevBtn.addEventListener('click', goToPreviousImage);
            nextBtn.addEventListener('click', goToNextImage);
            
            // زر الحفظ
            saveBtn.addEventListener('click', toggleSave);
            
            // زر إغلاق النافذة المنبثقة
            closeInfoBtn.addEventListener('click', hideNovelInfo);
            infoModal.addEventListener('click', function(e) {
                if (e.target === infoModal) {
                    hideNovelInfo();
                }
            });
            
            // النقر المزدوج لنسخ الرابط
            novelImage.addEventListener('dblclick', function(e) {
                e.preventDefault();
                copyShareLink();
            });
            
            // النقر المطول لعرض المعلومات
            let touchStartTime;
            let touchTimeout;
            
            // للكمبيوتر
            novelImage.addEventListener('mousedown', function(e) {
                longPressTimer = setTimeout(showNovelInfo, 700);
            });
            
            novelImage.addEventListener('mouseup', function() {
                clearTimeout(longPressTimer);
            });
            
            novelImage.addEventListener('mouseleave', function() {
                clearTimeout(longPressTimer);
            });
            
            // للجوال - التعامل مع اللمس
            novelImage.addEventListener('touchstart', function(e) {
                touchStartTime = new Date().getTime();
                touchTimeout = setTimeout(function() {
                    showNovelInfo();
                }, 700);
            });
            
            novelImage.addEventListener('touchend', function(e) {
                clearTimeout(touchTimeout);
                const touchDuration = new Date().getTime() - touchStartTime;
                
                // إذا كان اللمس أقل من 300 مللي ثانية وكانت هناك نقرة مزدوجة خلال 300 مللي ثانية
                if (touchDuration < 300 && (new Date().getTime() - lastTap) < 300) {
                    e.preventDefault();
                    copyShareLink();
                }
                
                lastTap = new Date().getTime();
            });
            
            // التعامل مع لوحة المفاتيح
            document.addEventListener('keydown', handleKeyPress);
            
            // تعامل مع حجم الصورة - التكبير عند النقر
            let isZoomed = false;
            novelImage.addEventListener('click', function(e) {
                // نتجاهل إذا كان اللمس طويلاً
                if (new Date().getTime() - touchStartTime > 500) return;
                
                if (!isZoomed) {
                    this.style.transform = 'scale(1.5)';
                    this.style.cursor = 'zoom-out';
                    isZoomed = true;
                } else {
                    this.style.transform = 'scale(1)';
                    this.style.cursor = 'zoom-in';
                    isZoomed = false;
                }
            });
            
            // منع التمرير عند لمس الصورة في الجوال
            novelViewer.addEventListener('touchmove', function(e) {
                if (isZoomed) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // للتعامل مع النقر المزدوج في الأجهزة اللمسية
        let lastTap = 0;

        // تهيئة التطبيق
        function initApp() {
            renderArcs();
            setupEventListeners();
            loadSavedState();
            
            // تحقق من وجود حالة محفوظة
            const savedNovel = localStorage.getItem('savedNovel');
            if (savedNovel) {
                try {
                    const saved = JSON.parse(savedNovel);
                    if (saved.title === novelData.title && saved.arcId && saved.chapterId) {
                        // تحميل الفصل المحفوظ
                        const arcItem = document.querySelector(`.arc-item[data-id="${saved.arcId}"]`);
                        if (arcItem) {
                            arcItem.classList.add('active');
                            
                            const chapterItem = document.querySelector(`.chapter-item[data-arc-id="${saved.arcId}"][data-chapter-id="${saved.chapterId}"]`);
                            if (chapterItem) {
                                chapterItem.classList.add('active');
                                currentArcId = saved.arcId;
                                currentChapterId = saved.chapterId;
                                currentImageIndex = saved.imageIndex || 0;
                                loadImage();
                                
                                // عرض إشعار باستئناف القراءة
                                showToast('تم استئناف القراءة من آخر موضع');
                            }
                        }
                    }
                } catch (error) {
                    console.error('خطأ في تحليل البيانات المحفوظة:', error);
                }
            } else {
                // إذا لم تكن هناك حالة محفوظة، نعرض معلومات الرواية تلقائياً عند التحميل الأول
                setTimeout(showNovelInfo, 500);
            }
        }

        // بدء التطبيق
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
