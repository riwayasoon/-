
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zaki Shopping</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            line-height: 1.6;
        }
        
        /* Header */
        header {
            background-color: #ffffff;
            border-bottom: 1px solid #d0d0d0;
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 1px;
            color: #000000;
        }
        
        /* Navigation */
        nav {
            display: flex;
            gap: 30px;
        }
        
        nav a {
            text-decoration: none;
            color: #000000;
            font-size: 12px;
            font-weight: 400;
            letter-spacing: 0.5px;
            transition: color 0.3s;
            border-bottom: 1px solid transparent;
            padding-bottom: 3px;
        }
        
        nav a:hover {
            color: #808080;
            border-bottom: 1px solid #808080;
        }
        
        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            padding: 60px 20px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .hero h1 {
            font-size: 36px;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 15px;
            color: #000000;
        }
        
        .hero p {
            font-size: 11px;
            color: #666666;
            letter-spacing: 0.8px;
            margin-bottom: 25px;
        }
        
        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        /* Products Section */
        .section-title {
            font-size: 16px;
            font-weight: 300;
            letter-spacing: 1px;
            margin-bottom: 30px;
            color: #000000;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #d0d0d0;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }
        
        .product-card {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .product-card:hover {
            border-color: #808080;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .product-card.selected {
            border-color: #000000;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12);
        }
        
        .product-image {
            width: 140px;
            height: 140px;
            background-color: #f0f0f0;
            border: 1px solid #d0d0d0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #999999;
        }
        
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-name {
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #000000;
            letter-spacing: 0.3px;
        }
        
        .product-price {
            font-size: 12px;
            color: #666666;
            margin-bottom: 12px;
            letter-spacing: 0.2px;
        }
        
        .product-btn {
            background-color: #000000;
            color: #ffffff;
            border: none;
            padding: 8px 20px;
            font-size: 9px;
            letter-spacing: 0.8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 300;
        }
        
        .product-btn:hover {
            background-color: #333333;
        }
        
        .product-btn.selected {
            background-color: #333333;
        }
        
        /* Contact Section */
        .contact-section {
            background-color: #f8f8f8;
            padding: 40px;
            margin-bottom: 50px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        
        .contact-section h2 {
            font-size: 14px;
            font-weight: 300;
            letter-spacing: 1px;
            margin-bottom: 20px;
            color: #000000;
        }
        
        .contact-info {
            font-size: 12px;
            color: #333333;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        .phone-link {
            color: #000000;
            text-decoration: none;
            font-weight: 500;
            border-bottom: 1px solid #000000;
            transition: all 0.3s;
        }
        
        .phone-link:hover {
            color: #808080;
            border-bottom-color: #808080;
        }
        
        /* Order Form Section */
        .order-section {
            background-color: #ffffff;
            padding: 40px;
            border: 1px solid #e0e0e0;
            opacity: 0.5;
            pointer-events: none;
            transition: all 0.5s;
        }
        
        .order-section.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .form-title {
            font-size: 14px;
            font-weight: 300;
            letter-spacing: 1px;
            margin-bottom: 30px;
            color: #000000;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #d0d0d0;
        }
        
        .form-container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-row-full {
            display: grid;
            grid-template-columns: 1fr;
        }
        
        label {
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.8px;
            margin-bottom: 6px;
            color: #000000;
            text-transform: uppercase;
        }
        
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        select,
        textarea {
            padding: 10px 12px;
            border: 1px solid #c0c0c0;
            background-color: #ffffff;
            font-size: 10px;
            font-family: inherit;
            letter-spacing: 0.3px;
            transition: all 0.3s;
            color: #000000;
        }
        
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #000000;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        
        select {
            cursor: pointer;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="black" stroke-width="1.5"><path d="M7 8l6 6 6-6"/></svg>');
            background-repeat: no-repeat;
            background-position: left 8px center;
            padding-right: 25px;
            padding-left: 12px;
        }
        
        .order-summary {
            background-color: #f8f8f8;
            border: 1px solid #e0e0e0;
            padding: 20px;
            margin-bottom: 25px;
            display: none;
        }
        
        .order-summary.visible {
            display: block;
        }
        
        .order-summary h3 {
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.8px;
            margin-bottom: 15px;
            color: #000000;
            text-align: center;
            text-transform: uppercase;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 10px;
            letter-spacing: 0.3px;
        }
        
        .summary-item:last-child {
            border-bottom: none;
            font-weight: 500;
            margin-top: 5px;
        }
        
        .summary-label {
            color: #666666;
        }
        
        .summary-value {
            color: #000000;
            font-weight: 500;
        }
        
        .submit-btn {
            background-color: #000000;
            color: #ffffff;
            border: none;
            padding: 12px 30px;
            font-size: 10px;
            font-weight: 400;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
            width: 100%;
            text-transform: uppercase;
        }
        
        .submit-btn:hover {
            background-color: #333333;
        }
        
        .submit-btn:active {
            background-color: #000000;
        }
        
        .submit-btn:disabled {
            background-color: #000000;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .confirm-btn {
            background-color: #000000;
            color: #ffffff;
            border: none;
            padding: 12px 30px;
            font-size: 10px;
            font-weight: 400;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
            width: 100%;
            text-transform: uppercase;
            display: none;
        }
        
        .confirm-btn.visible {
            display: block;
        }
        
        .confirm-btn:hover {
            background-color: #333333;
        }
        
        /* Footer */
        footer {
            background-color: #f8f8f8;
            border-top: 1px solid #d0d0d0;
            padding: 30px 20px;
            text-align: center;
            margin-top: 50px;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            font-size: 9px;
            color: #666666;
            letter-spacing: 0.5px;
        }
        
        .footer-content p {
            margin-bottom: 8px;
        }
        
        .divider {
            width: 30px;
            height: 1px;
            background-color: #c0c0c0;
            margin: 15px auto;
        }
        
        .order-message {
            font-size: 10px;
            color: #333333;
            letter-spacing: 0.3px;
            margin-bottom: 15px;
            text-align: center;
            padding: 10px;
            background-color: #f8f8f8;
            border: 1px solid #e0e0e0;
        }
        
        .error-message {
            font-size: 10px;
            color: #000000;
            letter-spacing: 0.3px;
            margin-bottom: 15px;
            text-align: center;
            padding: 10px;
            background-color: #f8f8f8;
            border: 1px solid #c0c0c0;
        }
        
        .success-message {
            font-size: 10px;
            color: #000000;
            letter-spacing: 0.3px;
            margin-bottom: 15px;
            text-align: center;
            padding: 12px;
            background-color: #f8f8f8;
            border: 1px solid #000000;
        }
        
        .input-error {
            border-color: #808080 !important;
        }
        
        .popular-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #000000;
            color: #ffffff;
            font-size: 8px;
            padding: 4px 8px;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
            }
            
            nav {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .hero h1 {
                font-size: 28px;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="logo">ZAKI SHOPPING</div>
            <nav>
                <a href="#home">الرئيسية</a>
                <a href="#products">المنتجات</a>
                <a href="#contact">اتصل بنا</a>
                <a href="#order">طلب</a>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="home">
        <h1>ZAKI SHOPPING</h1>
        <p>تجربة تسوق فاخرة وعصرية • الدفع عند الاستلام متوفر • لا حاجة للتسجيل</p>
    </section>

    <!-- Main Container -->
    <div class="container">
        <!-- Products Section -->
        <section id="products">
            <h2 class="section-title">منتجاتنا</h2>
            <div class="products-grid">
                <div class="product-card" data-product="منتج متميز 1" data-price="5,000 د.ج" data-clicks="0">
                    <div class="product-image">صورة منتج</div>
                    <div class="product-name">منتج متميز 1</div>
                    <div class="product-price">السعر: 5,000 د.ج</div>
                    <button class="product-btn">أضف للسلة</button>
                </div>
                
                <div class="product-card" data-product="منتج متميز 2" data-price="7,500 د.ج" data-clicks="0">
                    <div class="product-image">صورة منتج</div>
                    <div class="product-name">منتج متميز 2</div>
                    <div class="product-price">السعر: 7,500 د.ج</div>
                    <button class="product-btn">أضف للسلة</button>
                </div>
                
                <div class="product-card" data-product="منتج متميز 3" data-price="6,000 د.ج" data-clicks="0">
                    <div class="product-image">صورة منتج</div>
                    <div class="product-name">منتج متميز 3</div>
                    <div class="product-price">السعر: 6,000 د.ج</div>
                    <button class="product-btn">أضف للسلة</button>
                </div>
                
                <div class="product-card" data-product="منتج متميز 4" data-price="8,500 د.ج" data-clicks="0">
                    <div class="product-image">صورة منتج</div>
                    <div class="product-name">منتج متميز 4</div>
                    <div class="product-price">السعر: 8,500 د.ج</div>
                    <button class="product-btn">أضف للسلة</button>
                </div>
                
                <div class="product-card" data-product="منتج متميز 5" data-price="5,500 د.ج" data-clicks="0">
                    <div class="product-image">صورة منتج</div>
                    <div class="product-name">منتج متميز 5</div>
                    <div class="product-price">السعر: 5,500 د.ج</div>
                    <button class="product-btn">أضف للسلة</button>
                </div>
                
                <div class="product-card" data-product="منتج متميز 6" data-price="9,000 د.ج" data-clicks="0">
                    <div class="product-image">صورة منتج</div>
                    <div class="product-name">منتج متميز 6</div>
                    <div class="product-price">السعر: 9,000 د.ج</div>
                    <button class="product-btn">أضف للسلة</button>
                </div>
            </div>
        </section>
        
        <!-- Contact Section -->
        <section class="contact-section" id="contact">
            <h2>تواصل معنا</h2>
            <div class="contact-info">
                <p>للاستفسارات والطلبات</p>
            </div>
            <div class="contact-info">
                <p>رقم الهاتف: <a href="tel:0774843237" class="phone-link">0774843237</a></p>
            </div>
            <div class="contact-info">
                <p style="font-size: 10px; margin-top: 15px; letter-spacing: 0.3px;">اختر منتجك ثم أكمل بياناتك أدناه • سنتواصل معك خلال 24 ساعة</p>
            </div>
        </section>
    </div>

    <!-- Order Form Section -->
    <section class="order-section" id="order">
        <h2 class="form-title">نموذج الطلب</h2>
        <form class="form-container" id="orderForm">
            <div id="messageContainer"></div>
            
            <input type="hidden" id="selectedProduct" name="selectedProduct">
            <input type="hidden" id="selectedPrice" name="selectedPrice">
            
            <div class="form-row">
                <div class="form-group">
                    <label for="firstName">الاسم</label>
                    <input type="text" id="firstName" name="firstName" placeholder="أدخل اسمك" required disabled>
                </div>
                <div class="form-group">
                    <label for="lastName">اللقب</label>
                    <input type="text" id="lastName" name="lastName" placeholder="أدخل لقبك" disabled>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="phone">رقم الهاتف</label>
                    <input type="tel" id="phone" name="phone" placeholder="مثال: 0774843237" required inputmode="numeric" pattern="[0-9]{10}" disabled>
                </div>
                <div class="form-group">
                    <label for="email">البريد الإلكتروني</label>
                    <input type="email" id="email" name="email" placeholder="مثال: example@email.com" disabled>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="city">المدينة</label>
                    <input type="text" id="city" name="city" placeholder="أدخل مدينتك" disabled>
                </div>
                <div class="form-group">
                    <label for="wilaya">الولاية</label>
                    <select id="wilaya" name="wilaya" required disabled>
                        <option value="">-- اختر الولاية --</option>
                        <option value="1">1 - أدرار</option>
                        <option value="2">2 - الشلف</option>
                        <option value="3">3 - الأغواط</option>
                        <option value="4">4 - أم البواقي</option>
                        <option value="5">5 - باتنة</option>
                        <option value="6">6 - بجاية</option>
                        <option value="7">7 - بسكرة</option>
                        <option value="8">8 - بشار</option>
                        <option value="9">9 - البليدة</option>
                        <option value="10">10 - البويرة</option>
                        <option value="11">11 - تمنراست</option>
                        <option value="12">12 - تبسة</option>
                        <option value="13">13 - تلمسان</option>
                        <option value="14">14 - تيارت</option>
                        <option value="15">15 - تيزي وزو</option>
                        <option value="16">16 - الجزائر</option>
                        <option value="17">17 - الجلفة</option>
                        <option value="18">18 - جيجل</option>
                        <option value="19">19 - سطيف</option>
                        <option value="20">20 - سعيدة</option>
                        <option value="21">21 - سكيكدة</option>
                        <option value="22">22 - سيدي بلعباس</option>
                        <option value="23">23 - عنابة</option>
                        <option value="24">24 - قالمة</option>
                        <option value="25">25 - قسنطينة</option>
                        <option value="26">26 - المدية</option>
                        <option value="27">27 - مستغانم</option>
                        <option value="28">28 - المسيلة</option>
                        <option value="29">29 - معسكر</option>
                        <option value="30">30 - ورقلة</option>
                        <option value="31">31 - وهران</option>
                        <option value="32">32 - البيض</option>
                        <option value="33">33 - إليزي</option>
                        <option value="34">34 - برج بوعريريج</option>
                        <option value="35">35 - بومرداس</option>
                        <option value="36">36 - الطارف</option>
                        <option value="37">37 - تندوف</option>
                        <option value="38">38 - تيسمسيلت</option>
                        <option value="39">39 - الوادي</option>
                        <option value="40">40 - خنشلة</option>
                        <option value="41">41 - سوق أهراس</option>
                        <option value="42">42 - تيبازة</option>
                        <option value="43">43 - ميلة</option>
                        <option value="44">44 - عين الدفلى</option>
                        <option value="45">45 - النعامة</option>
                        <option value="46">46 - عين تموشنت</option>
                        <option value="47">47 - غرداية</option>
                        <option value="48">48 - غليزان</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row-full">
                <div class="form-group">
                    <label for="message">ملاحظات إضافية (اختياري)</label>
                    <textarea id="message" name="message" placeholder="أي ملاحظات أو طلبات خاصة..." disabled></textarea>
                </div>
            </div>
            
            <div class="order-summary" id="orderSummary">
                <h3>ملخص الطلب</h3>
                <div class="summary-item">
                    <span class="summary-label">المنتج:</span>
                    <span class="summary-value" id="summaryProduct">-</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">السعر:</span>
                    <span class="summary-value" id="summaryPrice">-</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">الاسم الكامل:</span>
                    <span class="summary-value" id="summaryName">-</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">رقم الهاتف:</span>
                    <span class="summary-value" id="summaryPhone">-</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">الولاية:</span>
                    <span class="summary-value" id="summaryWilaya">-</span>
                </div>
            </div>
            
            <button type="submit" class="submit-btn" id="submitBtn" disabled>معاينة الطلب</button>
            <button type="button" class="confirm-btn" id="confirmBtn">تأكيد و إرسال الطلب</button>
        </form>
    </section>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <p>© 2025 ZAKI SHOPPING جميع الحقوق محفوظة</p>
            <div class="divider"></div>
            <p>شكراً لتعاملك معنا</p>
            <p style="margin-top: 12px;">رقم الهاتف: <a href="tel:0774843237" style="color: #000000; font-weight: 500; text-decoration: none;">0774843237</a></p>
        </div>
    </footer>

    <script>
        (function() {
            // ========== نظام التحليل الذكي الداخلي ==========
            
            const AnalyticsEngine = {
                // تتبع حالة الطلب وثقة النظام
                confidenceTracker: {
                    inputStability: {},
                    modificationCounts: {},
                    lastValues: {},
                    stabilityScore: 0,
                    
                    trackChange(fieldId, newValue) {
                        if (!this.modificationCounts[fieldId]) {
                            this.modificationCounts[fieldId] = 0;
                            this.lastValues[fieldId] = '';
                        }
                        
                        if (this.lastValues[fieldId] !== newValue) {
                            this.modificationCounts[fieldId]++;
                            this.lastValues[fieldId] = newValue;
                            this.calculateStability(fieldId);
                        }
                    },
                    
                    calculateStability(fieldId) {
                        const mods = this.modificationCounts[fieldId] || 0;
                        this.inputStability[fieldId] = Math.max(0, 100 - (mods * 5));
                        this.updateOverallStability();
                    },
                    
                    updateOverallStability() {
                        const scores = Object.values(this.inputStability);
                        this.stabilityScore = scores.length > 0 
                            ? scores.reduce((a, b) => a + b, 0) / scores.length 
                            : 0;
                    },
                    
                    getConfidenceLevel() {
                        if (this.stabilityScore >= 80) return 'high';
                        if (this.stabilityScore >= 50) return 'medium';
                        return 'low';
                    }
                },
                
                // تحليل سلوك القراءة والتفاعل
                behaviorAnalyzer: {
                    sections: ['products', 'contact', 'order'],
                    sectionTimes: {},
                    scrollPattern: [],
                    focusPattern: [],
                    pageLoadTime: Date.now(),
                    
                    trackSectionView(sectionId, duration) {
                        if (!this.sectionTimes[sectionId]) {
                            this.sectionTimes[sectionId] = [];
                        }
                        this.sectionTimes[sectionId].push(duration);
                    },
                    
                    trackScrollBehavior(scrollY, timestamp) {
                        this.scrollPattern.push({
                            y: scrollY,
                            time: timestamp - this.pageLoadTime,
                            speed: this.calculateScrollSpeed()
                        });
                        
                        if (this.scrollPattern.length > 50) {
                            this.scrollPattern.shift();
                        }
                    },
                    
                    calculateScrollSpeed() {
                        if (this.scrollPattern.length < 2) return 0;
                        const prev = this.scrollPattern[this.scrollPattern.length - 1];
                        const curr = this.scrollPattern[this.scrollPattern.length - 2];
                        const distance = Math.abs(prev.y - curr.y);
                        const time = prev.time - curr.time;
                        return time > 0 ? distance / time : 0;
                    },
                    
                    analyzeReadingIntent() {
                        const avgSpeed = this.scrollPattern.reduce((sum, p) => sum + p.speed, 0) / this.scrollPattern.length;
                        const isReading = avgSpeed < 2;
                        const isSkipping = avgSpeed > 5;
                        
                        return {
                            isReading,
                            isSkipping,
                            engagement: isReading ? 'high' : isSkipping ? 'low' : 'medium'
                        };
                    }
                },
                
                // نظام التوقيت الذكي
                timingSystem: {
                    events: [],
                    productViewTime: 0,
                    formStartTime: null,
                    confirmationHesitation: 0,
                    
                    recordEvent(eventType, metadata = {}) {
                        this.events.push({
                            type: eventType,
                            timestamp: Date.now(),
                            metadata
                        });
                    },
                    
                    calculateOptimalSubmitTime() {
                        const formDuration = this.formStartTime 
                            ? Date.now() - this.formStartTime 
                            : 0;
                        
                        const isRushed = formDuration < 30000;
                        const isDelayed = formDuration > 300000;
                        
                        return {
                            duration: formDuration,
                            isOptimal: !isRushed && !isDelayed,
                            classification: isRushed ? 'rushed' : isDelayed ? 'delayed' : 'normal'
                        };
                    },
                    
                    trackConfirmationHesitation(startTime) {
                        this.confirmationHesitation = Date.now() - startTime;
                        return this.confirmationHesitation > 3000;
                    }
                },
                
                // تحليل مسار التفاعل
                interactionPath: {
                    journey: [],
                    transitions: {},
                    
                    recordStep(step, action) {
                        this.journey.push({
                            step,
                            action,
                            timestamp: Date.now()
                        });
                        
                        this.analyzeTransitions();
                    },
                    
                    analyzeTransitions() {
                        if (this.journey.length < 2) return;
                        
                        for (let i = 1; i < this.journey.length; i++) {
                            const from = this.journey[i - 1].step;
                            const to = this.journey[i].step;
                            const key = `${from}->${to}`;
                            
                            this.transitions[key] = (this.transitions[key] || 0) + 1;
                        }
                    },
                    
                    getMostCommonPath() {
                        return Object.entries(this.transitions)
                            .sort((a, b) => b[1] - a[1])[0];
                    }
                },
                
                // قياس توازن الجهد
                effortBalance: {
                    productSelectionEffort: 0,
                    formFillingEffort: 0,
                    
                    measureProductEffort(clicks, viewTime) {
                        this.productSelectionEffort = (clicks * 1000) + viewTime;
                    },
                    
                    measureFormEffort(fieldCount, totalTime, modifications) {
                        this.formFillingEffort = (fieldCount * 500) + totalTime + (modifications * 100);
                    },
                    
                    isBalanced() {
                        if (this.productSelectionEffort === 0 || this.formFillingEffort === 0) {
                            return null;
                        }
                        
                        const ratio = this.productSelectionEffort / this.formFillingEffort;
                        return ratio >= 0.3 && ratio <= 3.0;
                    }
                },
                
                // نظام ترتيب التحقق الديناميكي
                validationPriority: {
                    fieldPriorities: {
                        firstName: 10,
                        phone: 10,
                        wilaya: 8,
                        lastName: 5,
                        city: 5,
                        email: 3,
                        message: 1
                    },
                    
                    adjustPriority(fieldId, interactionCount) {
                        if (this.fieldPriorities[fieldId]) {
                            this.fieldPriorities[fieldId] = Math.min(15, 
                                this.fieldPriorities[fieldId] + (interactionCount * 0.5));
                        }
                    },
                    
                    getValidationOrder() {
                        return Object.entries(this.fieldPriorities)
                            .sort((a, b) => b[1] - a[1])
                            .map(entry => entry[0]);
                    }
                },
                
                // تقييم جودة الاتصال (بناءً على الاستجابة)
                connectionQuality: {
                    responseTimes: [],
                    
                    recordResponseTime(eventType, duration) {
                        this.responseTimes.push({
                            event: eventType,
                            duration,
                            timestamp: Date.now()
                        });
                        
                        if (this.responseTimes.length > 20) {
                            this.responseTimes.shift();
                        }
                    },
                    
                    estimateQuality() {
                        if (this.responseTimes.length === 0) return 'unknown';
                        
                        const avgResponse = this.responseTimes.reduce((sum, r) => 
                            sum + r.duration, 0) / this.responseTimes.length;
                        
                        if (avgResponse < 50) return 'excellent';
                        if (avgResponse < 150) return 'good';
                        if (avgResponse < 300) return 'fair';
                        return 'poor';
                    }
                },
                
                // كشف التردد والتوقفات
                hesitationDetector: {
                    pauses: [],
                    
                    recordPause(location, duration) {
                        this.pauses.push({
                            location,
                            duration,
                            timestamp: Date.now()
                        });
                    },
                    
                    analyzeHesitation() {
                        const longPauses = this.pauses.filter(p => p.duration > 5000);
                        const hasSignificantHesitation = longPauses.length > 2;
                        
                        return {
                            totalPauses: this.pauses.length,
                            longPauses: longPauses.length,
                            isHesitant: hasSignificantHesitation,
                            confidence: hasSignificantHesitation ? 'low' : 'high'
                        };
                    }
                },
                
                // تصنيف الطلبات حسب الاستعجال
                urgencyClassifier: {
                    classify(interactionData) {
                        const {
                            totalTime,
                            modificationCount,
                            hesitationLevel
                        } = interactionData;
                        
                        const isUrgent = totalTime < 60000 && modificationCount < 3;
                        const isRelaxed = totalTime > 300000;
                        const isNormal = !isUrgent && !isRelaxed;
                        
                        return {
                            level: isUrgent ? 'urgent' : isRelaxed ? 'relaxed' : 'normal',
                            score: isUrgent ? 3 : isNormal ? 2 : 1,
                            recommendation: isUrgent ? 'prioritize' : 'standard'
                        };
                    }
                },
                
                // فحص تناسق المدخلات
                consistencyChecker: {
                    patterns: {},
                    
                    checkPattern(fieldId, value) {
                        if (!this.patterns[fieldId]) {
                            this.patterns[fieldId] = [];
                        }
                        
                        this.patterns[fieldId].push(value);
                        
                        const duplicates = this.patterns[fieldId].filter(v => v === value).length;
                        const totalCount = this.patterns[fieldId].length;
                        
                        return {
                            isDuplicate: duplicates > 1,
                            consistency: duplicates / totalCount,
                            suspicious: this.checkCrossDuplication(value)
                        };
                    },
                    
                    checkCrossDuplication(value) {
                        let count = 0;
                        for (const fieldValues of Object.values(this.patterns)) {
                            if (fieldValues.includes(value)) count++;
                        }
                        return count > 2;
                    }
                },
                
                // نظام الوزن الديناميكي للحقول
                fieldWeighting: {
                    weights: {
                        firstName: 1.0,
                        lastName: 0.7,
                        phone: 1.0,
                        email: 0.5,
                        city: 0.6,
                        wilaya: 1.0,
                        message: 0.3
                    },
                    
                    adjustWeight(fieldId, completionQuality) {
                        if (this.weights[fieldId]) {
                            this.weights[fieldId] *= completionQuality;
                        }
                    },
                    
                    calculateReadiness(filledFields) {
                        let totalWeight = 0;
                        let achievedWeight = 0;
                        
                        for (const [field, weight] of Object.entries(this.weights)) {
                            totalWeight += weight;
                            if (filledFields.includes(field)) {
                                achievedWeight += weight;
                            }
                        }
                        
                        return (achievedWeight / totalWeight) * 100;
                    }
                },
                
                // كشف نوع التفاعل (خطي/متقطع)
                interactionPattern: {
                    events: [],
                    
                    recordInteraction(type, fieldId) {
                        this.events.push({
                            type,
                            field: fieldId,
                            timestamp: Date.now()
                        });
                    },
                    
                    analyzePattern() {
                        if (this.events.length < 5) return 'insufficient_data';
                        
                        let sequentialCount = 0;
                        let jumpCount = 0;
                        
                        for (let i = 1; i < this.events.length; i++) {
                            const timeDiff = this.events[i].timestamp - this.events[i - 1].timestamp;
                            
                            if (timeDiff < 2000) {
                                sequentialCount++;
                            } else if (timeDiff > 10000) {
                                jumpCount++;
                            }
                        }
                        
                        const isLinear = sequentialCount > jumpCount;
                        
                        return {
                            pattern: isLinear ? 'linear' : 'fragmented',
                            continuity: sequentialCount / this.events.length,
                            distraction: jumpCount / this.events.length
                        };
                    }
                },
                
                // مراقبة الاستخدام غير المقصود
                accidentalUseDetector: {
                    rapidActions: [],
                    
                    recordAction(actionType, duration) {
                        this.rapidActions.push({
                            type: actionType,
                            duration,
                            timestamp: Date.now()
                        });
                        
                        if (this.rapidActions.length > 10) {
                            this.rapidActions.shift();
                        }
                    },
                    
                    detectAccidental() {
                        const veryFastActions = this.rapidActions.filter(a => a.duration < 100);
                        const isLikelyAccidental = veryFastActions.length > 3;
                        
                        return {
                            suspicious: isLikelyAccidental,
                            fastActionRatio: veryFastActions.length / this.rapidActions.length,
                            recommendation: isLikelyAccidental ? 'confirm_intent' : 'proceed'
                        };
                    }
                },
                
                // مقارنة السرعة مع المتوسط
                speedComparator: {
                    historicalSpeeds: [],
                    
                    recordSpeed(userId, inputSpeed) {
                        const existing = this.historicalSpeeds.find(h => h.userId === userId);
                        
                        if (existing) {
                            existing.speeds.push(inputSpeed);
                            if (existing.speeds.length > 5) {
                                existing.speeds.shift();
                            }
                        } else {
                            this.historicalSpeeds.push({
                                userId,
                                speeds: [inputSpeed]
                            });
                        }
                    },
                    
                    compareToAverage(userId, currentSpeed) {
                        const user = this.historicalSpeeds.find(h => h.userId === userId);
                        if (!user || user.speeds.length === 0) return null;
                        
                        const avgSpeed = user.speeds.reduce((a, b) => a + b, 0) / user.speeds.length;
                        const deviation = Math.abs(currentSpeed - avgSpeed) / avgSpeed;
                        
                        return {
                            average: avgSpeed,
                            current: currentSpeed,
                            deviation,
                            isUnusual: deviation > 0.5
                        };
                    }
                },
                
                // تمييز الدافع (فضول/نية حقيقية)
                intentAnalyzer: {
                    signals: [],
                    
                    recordSignal(signalType, value) {
                        this.signals.push({
                            type: signalType,
                            value,
                            timestamp: Date.now()
                        });
                    },
                    
                    determineIntent() {
                        const positiveSignals = [
                            'product_review_time',
                            'form_completion',
                            'careful_input',
                            'confirmation_review'
                        ];
                        
                        const negativeSignals = [
                            'rapid_navigation',
                            'incomplete_fields',
                            'no_product_selection',
                            'immediate_exit'
                        ];
                        
                        const positiveCount = this.signals.filter(s => 
                            positiveSignals.includes(s.type)).length;
                        const negativeCount = this.signals.filter(s => 
                            negativeSignals.includes(s.type)).length;
                        
                        const score = (positiveCount - negativeCount) / this.signals.length;
                        
                        return {
                            intent: score > 0.3 ? 'genuine' : score < -0.3 ? 'curious' : 'uncertain',
                            score,
                            confidence: Math.abs(score)
                        };
                    }
                },
                
                // فصل البيانات النهائية والتجريبية
                dataStateManager: {
                    experimentalData: {},
                    finalData: {},
                    
                    markAsExperimental(fieldId, value) {
                        this.experimentalData[fieldId] = value;
                    },
                    
                    promoteToFinal(fieldId) {
                        if (this.experimentalData[fieldId]) {
                            this.finalData[fieldId] = this.experimentalData[fieldId];
                            delete this.experimentalData[fieldId];
                        }
                    },
                    
                    getDataQuality() {
                        const totalFields = Object.keys(this.experimentalData).length + 
                                          Object.keys(this.finalData).length;
                        const finalFields = Object.keys(this.finalData).length;
                        
                        return {
                            completeness: totalFields > 0 ? (finalFields / totalFields) * 100 : 0,
                            experimental: Object.keys(this.experimentalData).length,
                            finalized: finalFields
                        };
                    }
                },
                
                // مراقبة استقرار التركيز
                focusStabilityMonitor: {
                    focusEvents: [],
                    blurEvents: [],
                    
                    recordFocus(timestamp) {
                        this.focusEvents.push(timestamp);
                    },
                    
                    recordBlur(timestamp) {
                        this.blurEvents.push(timestamp);
                    },
                    
                    calculateStability() {
                        const totalEvents = this.focusEvents.length + this.blurEvents.length;
                        if (totalEvents === 0) return 100;
                        
                        const focusRatio = this.focusEvents.length / totalEvents;
                        const stability = focusRatio * 100;
                        
                        return {
                            stability,
                            switches: this.blurEvents.length,
                            isStable: stability > 70
                        };
                    }
                },
                
                // تحديد مستوى الإلمام التقني
                technicalProficiencyDetector: {
                    indicators: {
                        keyboardShortcuts: 0,
                        navigationSpeed: 0,
                        errorRecovery: 0,
                        formAutofill: 0
                    },
                    
                    recordIndicator(type, value) {
                        if (this.indicators.hasOwnProperty(type)) {
                            this.indicators[type] += value;
                        }
                    },
                    
                    assessProficiency() {
                        const total = Object.values(this.indicators).reduce((a, b) => a + b, 0);
                        const maxPossible = Object.keys(this.indicators).length * 10;
                        const score = (total / maxPossible) * 100;
                        
                        return {
                            level: score > 70 ? 'advanced' : score > 40 ? 'intermediate' : 'beginner',
                            score,
                            details: this.indicators
                        };
                    }
                },
                
                // تقدير العبء الذهني
                cognitiveLoadEstimator: {
                    complexityFactors: {
                        fieldCount: 0,
                        validationRules: 0,
                        decisionPoints: 0,
                        informationDensity: 0
                    },
                    
                    setFactor(factor, value) {
                        if (this.complexityFactors.hasOwnProperty(factor)) {
                            this.complexityFactors[factor] = value;
                        }
                    },
                    
                    estimateLoad() {
                        const weights = {
                            fieldCount: 0.3,
                            validationRules: 0.25,
                            decisionPoints: 0.25,
                            informationDensity: 0.2
                        };
                        
                        let totalLoad = 0;
                        for (const [factor, value] of Object.entries(this.complexityFactors)) {
                            totalLoad += value * weights[factor];
                        }
                        
                        return {
                            load: totalLoad,
                            level: totalLoad > 7 ? 'high' : totalLoad > 4 ? 'medium' : 'low',
                            optimization: totalLoad > 7 ? 'simplify' : 'maintain'
                        };
                    }
                },
                
                // كشف طريقة الإدخال
                inputMethodDetector: {
                    methods: {
                        typing: 0,
                        pasting: 0,
                        autofill: 0
                    },
                    
                    recordMethod(fieldId, method, confidence) {
                        this.methods[method] = (this.methods[method] || 0) + confidence;
                    },
                    
                    getPrimaryMethod() {
                        const sorted = Object.entries(this.methods)
                            .sort((a, b) => b[1] - a[1]);
                        
                        return {
                            primary: sorted[0][0],
                            distribution: this.methods,
                            diversity: Object.values(this.methods).filter(v => v > 0).length
                        };
                    }
                },
                
                // نظام التنبؤ بإكمال الطلب
                completionPredictor: {
                    factors: [],
                    
                    addFactor(name, value, weight) {
                        this.factors.push({ name, value, weight });
                    },
                    
                    predict() {
                        if (this.factors.length === 0) return null;
                        
                        let totalScore = 0;
                        let totalWeight = 0;
                        
                        for (const factor of this.factors) {
                            totalScore += factor.value * factor.weight;
                            totalWeight += factor.weight;
                        }
                        
                        const probability = (totalScore / totalWeight) * 100;
                        
                        return {
                            probability,
                            willComplete: probability > 70,
                            confidence: probability > 50 ? 'high' : 'low',
                            factors: this.factors
                        };
                    }
                },
                
                // إدارة أولويات العمليات
                processPriorityManager: {
                    processes: {},
                    
                    registerProcess(name, priority, phase) {
                        this.processes[name] = {
                            priority,
                            phase,
                            lastRun: null,
                            runCount: 0
                        };
                    },
                    
                    getNextProcess(currentPhase) {
                        const eligible = Object.entries(this.processes)
                            .filter(([_, p]) => p.phase === currentPhase)
                            .sort((a, b) => b[1].priority - a[1].priority);
                        
                        if (eligible.length > 0) {
                            const [name, process] = eligible[0];
                            process.lastRun = Date.now();
                            process.runCount++;
                            return name;
                        }
                        
                        return null;
                    }
                },
                
                // نظام التقييم الشامل
                comprehensiveScoring: {
                    calculateOverallScore() {
                        return {
                            confidence: AnalyticsEngine.confidenceTracker.getConfidenceLevel(),
                            engagement: AnalyticsEngine.behaviorAnalyzer.analyzeReadingIntent().engagement,
                            timing: AnalyticsEngine.timingSystem.calculateOptimalSubmitTime().classification,
                            intent: AnalyticsEngine.intentAnalyzer.determineIntent().intent,
                            stability: AnalyticsEngine.confidenceTracker.stabilityScore,
                            readiness: AnalyticsEngine.fieldWeighting.calculateReadiness(['firstName', 'phone', 'wilaya']),
                            quality: AnalyticsEngine.connectionQuality.estimateQuality(),
                            timestamp: Date.now()
                        };
                    },
                    
                    generateReport() {
                        const score = this.calculateOverallScore();
                        
                        console.log('=== تقرير التحليل الشامل ===');
                        console.log('مستوى الثقة:', score.confidence);
                        console.log('مستوى التفاعل:', score.engagement);
                        console.log('التصنيف الزمني:', score.timing);
                        console.log('النية المتوقعة:', score.intent);
                        console.log('درجة الاستقرار:', score.stability.toFixed(2));
                        console.log('نسبة الجاهزية:', score.readiness.toFixed(2) + '%');
                        console.log('جودة الاتصال:', score.quality);
                        console.log('============================');
                        
                        return score;
                    }
                }
            };
            
            // ========== التكامل مع النظام الأساسي ==========
            
            const DEFAULT_PRODUCT = 'منتج متميز 1';
            const DEFAULT_PRICE = '5,000 د.ج';
            
            const orderData = {
                product: '',
                price: '',
                isConfirmed: false
            };
            
            let isSubmitting = false;
            const form = document.getElementById('orderForm');
            const orderSection = document.querySelector('.order-section');
            const messageContainer = document.getElementById('messageContainer');
            const submitBtn = document.getElementById('submitBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const orderSummary = document.getElementById('orderSummary');
            const phoneInput = document.getElementById('phone');
            const emailInput = document.getElementById('email');
            
            const formInputs = [
                document.getElementById('firstName'),
                document.getElementById('lastName'),
                phoneInput,
                emailInput,
                document.getElementById('city'),
                document.getElementById('wilaya'),
                document.getElementById('message')
            ];
            
            // تهيئة نظام التحليل
            AnalyticsEngine.timingSystem.recordEvent('page_load');
            AnalyticsEngine.interactionPath.recordStep('initial', 'page_view');
            
            // مراقبة التمرير
            let scrollTimeout;
            window.addEventListener('scroll', function() {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    AnalyticsEngine.behaviorAnalyzer.trackScrollBehavior(
                        window.scrollY, 
                        Date.now()
                    );
                }, 100);
            });
            
            // مراقبة التركيز
            window.addEventListener('focus', () => {
                AnalyticsEngine.focusStabilityMonitor.recordFocus(Date.now());
            });
            
            window.addEventListener('blur', () => {
                AnalyticsEngine.focusStabilityMonitor.recordBlur(Date.now());
            });
            
            function showMessage(text, type) {
                messageContainer.innerHTML = `<div class="${type}-message">${text}</div>`;
                messageContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                AnalyticsEngine.interactionPath.recordStep('message', type);
            }
            
            function enableForm() {
                orderSection.classList.add('active');
                formInputs.forEach(input => {
                    if (input) input.disabled = false;
                });
                submitBtn.disabled = false;
                
                if (!AnalyticsEngine.timingSystem.formStartTime) {
                    AnalyticsEngine.timingSystem.formStartTime = Date.now();
                }
                
                AnalyticsEngine.interactionPath.recordStep('form', 'enabled');
            }
            
            function disableForm() {
                orderSection.classList.remove('active');
                formInputs.forEach(input => {
                    if (input) input.disabled = true;
                });
                submitBtn.disabled = true;
                
                AnalyticsEngine.interactionPath.recordStep('form', 'disabled');
            }
            
            function saveFormData() {
                const formData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    phone: phoneInput.value,
                    email: emailInput.value,
                    city: document.getElementById('city').value,
                    wilaya: document.getElementById('wilaya').value,
                    message: document.getElementById('message').value
                };
                localStorage.setItem('formData', JSON.stringify(formData));
            }
            
            function loadFormData() {
                const saved = localStorage.getItem('formData');
                if (saved) {
                    const data = JSON.parse(saved);
                    document.getElementById('firstName').value = data.firstName || '';
                    document.getElementById('lastName').value = data.lastName || '';
                    phoneInput.value = data.phone || '';
                    emailInput.value = data.email || '';
                    document.getElementById('city').value = data.city || '';
                    document.getElementById('wilaya').value = data.wilaya || '';
                    document.getElementById('message').value = data.message || '';
                }
            }
            
            function updateProductClicks(productName, increment = true) {
                const clicks = JSON.parse(localStorage.getItem('productClicks') || '{}');
                clicks[productName] = (clicks[productName] || 0) + (increment ? 1 : 0);
                localStorage.setItem('productClicks', JSON.stringify(clicks));
                
                AnalyticsEngine.interactionPath.recordStep('product', 'click');
                return clicks;
            }
            
            function getMostPopularProduct() {
                const clicks = JSON.parse(localStorage.getItem('productClicks') || '{}');
                let maxClicks = 0;
                let popularProduct = null;
                
                for (const [product, count] of Object.entries(clicks)) {
                    if (count > maxClicks) {
                        maxClicks = count;
                        popularProduct = product;
                    }
                }
                
                return popularProduct;
            }
            
            function updatePopularBadges() {
                const mostPopular = getMostPopularProduct();
                document.querySelectorAll('.popular-badge').forEach(badge => badge.remove());
                
                if (mostPopular) {
                    const cards = document.querySelectorAll('.product-card');
                    cards.forEach(card => {
                        if (card.dataset.product === mostPopular) {
                            const badge = document.createElement('div');
                            badge.className = 'popular-badge';
                            badge.textContent = 'الأكثر طلباً';
                            card.appendChild(badge);
                        }
                    });
                }
            }
            
            function updateSummary() {
                const firstName = document.getElementById('firstName').value.trim();
                const lastName = document.getElementById('lastName').value.trim();
                const phone = phoneInput.value.trim();
                const wilayaSelect = document.getElementById('wilaya');
                const wilayaText = wilayaSelect.options[wilayaSelect.selectedIndex]?.text || '-';
                
                document.getElementById('summaryProduct').textContent = orderData.product || '-';
                document.getElementById('summaryPrice').textContent = orderData.price || '-';
                document.getElementById('summaryName').textContent = 
                    (firstName || lastName) ? `${firstName} ${lastName}`.trim() : '-';
                document.getElementById('summaryPhone').textContent = phone || '-';
                document.getElementById('summaryWilaya').textContent = wilayaText;
            }
            
            function checkForLastOrder() {
                const lastOrder = localStorage.getItem('lastSuccessfulOrder');
                if (lastOrder) {
                    const orderTime = parseInt(lastOrder);
                    const now = Date.now();
                    const hoursPassed = (now - orderTime) / (1000 * 60 * 60);
                    
                    if (hoursPassed < 24) {
                        showMessage('لقد قمت بإرسال طلب مؤخراً • يرجى الانتظار 24 ساعة قبل إرسال طلب جديد', 'error');
                        AnalyticsEngine.interactionPath.recordStep('validation', 'order_limit_reached');
                        return true;
                    } else {
                        localStorage.removeItem('lastSuccessfulOrder');
                    }
                }
                return false;
            }
            
            loadFormData();
            updatePopularBadges();
            
            if (!checkForLastOrder()) {
                const savedProduct = localStorage.getItem('selectedProduct');
                const savedPrice = localStorage.getItem('selectedPrice');
                
                if (savedProduct && savedPrice) {
                    orderData.product = savedProduct;
                    orderData.price = savedPrice;
                    document.getElementById('selectedProduct').value = savedProduct;
                    document.getElementById('selectedPrice').value = savedPrice;
                    showMessage(`تم اختيار: ${savedProduct} - ${savedPrice} • يرجى إكمال بياناتك أدناه`, 'order');
                    enableForm();
                    
                    const cards = document.querySelectorAll('.product-card');
                    cards.forEach(card => {
                        if (card.dataset.product === savedProduct) {
                            card.classList.add('selected');
                            card.querySelector('.product-btn').classList.add('selected');
                        }
                    });
                }
            }
            
            // معالج اختيار المنتج
            const productViewStartTime = Date.now();
            document.querySelector('.products-grid').addEventListener('click', function(e) {
                if (e.target.classList.contains('product-btn')) {
                    const actionStart = Date.now();
                    
                    if (checkForLastOrder()) {
                        return;
                    }
                    
                    const card = e.target.closest('.product-card');
                    const productName = card.dataset.product;
                    const productPrice = card.dataset.price;
                    
                    const viewDuration = Date.now() - productViewStartTime;
                    AnalyticsEngine.effortBalance.measureProductEffort(1, viewDuration);
                    AnalyticsEngine.timingSystem.recordEvent('product_selected', { 
                        product: productName,
                        viewDuration 
                    });
                    
                    orderData.product = productName;
                    orderData.price = productPrice;
                    orderData.isConfirmed = false;
                    
                    document.getElementById('selectedProduct').value = productName;
                    document.getElementById('selectedPrice').value = productPrice;
                    
                    localStorage.setItem('selectedProduct', productName);
                    localStorage.setItem('selectedPrice', productPrice);
                    
                    updateProductClicks(productName, true);
                    updatePopularBadges();
                    
                    const allCards = document.querySelectorAll('.product-card');
                    allCards.forEach(c => {
                        c.classList.remove('selected');
                        c.querySelector('.product-btn').classList.remove('selected');
                    });
                    
                    card.classList.add('selected');
                    e.target.classList.add('selected');
                    
                    showMessage(`تم اختيار: ${productName} - ${productPrice} • يرجى إكمال بياناتك أدناه`, 'order');
                    enableForm();
                    
                    orderSummary.classList.remove('visible');
                    confirmBtn.classList.remove('visible');
                    submitBtn.textContent = 'معاينة الطلب';
                    submitBtn.style.display = 'block';
                    
                    AnalyticsEngine.intentAnalyzer.recordSignal('product_review_time', viewDuration);
                    
                    const actionDuration = Date.now() - actionStart;
                    AnalyticsEngine.accidentalUseDetector.recordAction('product_select', actionDuration);
                    AnalyticsEngine.connectionQuality.recordResponseTime('product_selection', actionDuration);
                    
                    setTimeout(() => {
                        document.getElementById('order').scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                }
            });
            
            // مراقبة إدخال الهاتف
            let phoneLastInput = Date.now();
            phoneInput.addEventListener('input', function(e) {
                const inputSpeed = Date.now() - phoneLastInput;
                phoneLastInput = Date.now();
                
                this.value = this.value.replace(/[^0-9]/g, '');
                
                AnalyticsEngine.confidenceTracker.trackChange('phone', this.value);
                AnalyticsEngine.dataStateManager.markAsExperimental('phone', this.value);
                AnalyticsEngine.interactionPattern.recordInteraction('input', 'phone');
                
                const method = inputSpeed < 100 ? 'pasting' : 'typing';
                AnalyticsEngine.inputMethodDetector.recordMethod('phone', method, 1);
                
                if (this.value.length > 0 && this.value.length !== 10) {
                    this.classList.add('input-error');
                } else {
                    this.classList.remove('input-error');
                    if (this.value.length === 10) {
                        AnalyticsEngine.dataStateManager.promoteToFinal('phone');
                    }
                }
                updateSummary();
            });
            
            // مراقبة البريد الإلكتروني
            emailInput.addEventListener('blur', function() {
                if (this.value && !this.validity.valid) {
                    this.classList.add('input-error');
                } else {
                    this.classList.remove('input-error');
                    if (this.value) {
                        AnalyticsEngine.dataStateManager.promoteToFinal('email');
                    }
                }
                
                AnalyticsEngine.confidenceTracker.trackChange('email', this.value);
            });
            
            // مراقبة جميع الحقول
            formInputs.forEach((input, index) => {
                if (!input) return;
                
                let lastFocusTime = null;
                
                input.addEventListener('focus', () => {
                    lastFocusTime = Date.now();
                    AnalyticsEngine.interactionPattern.recordInteraction('focus', input.id);
                });
                
                input.addEventListener('blur', () => {
                    if (lastFocusTime) {
                        const duration = Date.now() - lastFocusTime;
                        if (duration > 5000) {
                            AnalyticsEngine.hesitationDetector.recordPause(input.id, duration);
                        }
                    }
                });
                
                input.addEventListener('input', () => {
                    AnalyticsEngine.validationPriority.adjustPriority(input.id, 1);
                });
            });
            
            // مراقبة التغييرات في النموذج
            form.addEventListener('input', function(e) {
                saveFormData();
                updateSummary();
                
                AnalyticsEngine.interactionPattern.recordInteraction('input', e.target.id);
                
                const filledFields = Array.from(formInputs)
                    .filter(input => input && input.value.trim() !== '')
                    .map(input => input.id);
                
                AnalyticsEngine.intentAnalyzer.recordSignal('form_completion', filledFields.length);
            });
            
            // معالج إرسال النموذج
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (isSubmitting || orderData.isConfirmed) return;
                
                const submitStartTime = Date.now();
                
                if (!orderData.product) {
                    showMessage('يرجى اختيار منتج من القائمة أعلاه قبل إرسال الطلب', 'error');
                    AnalyticsEngine.intentAnalyzer.recordSignal('no_product_selection', 1);
                    setTimeout(() => {
                        document.getElementById('products').scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                    return;
                }
                
                const firstName = document.getElementById('firstName').value.trim();
                const phone = phoneInput.value.trim();
                const wilaya = document.getElementById('wilaya').value;
                
                // التحقق بالترتيب الديناميكي
                const validationOrder = AnalyticsEngine.validationPriority.getValidationOrder();
                
                for (const fieldId of validationOrder) {
                    const field = document.getElementById(fieldId);
                    if (!field) continue;
                    
                    if (fieldId === 'firstName' && !firstName) {
                        showMessage('يرجى إدخال الاسم', 'error');
                        field.focus();
                        return;
                    }
                    
                    if (fieldId === 'phone' && (!phone || phone.length !== 10)) {
                        showMessage('يرجى إدخال رقم هاتف صحيح (10 أرقام)', 'error');
                        phoneInput.focus();
                        return;
                    }
                    
                    if (fieldId === 'wilaya' && !wilaya) {
                        showMessage('يرجى اختيار الولاية', 'error');
                        field.focus();
                        return;
                    }
                }
                
                // حساب الجهد المبذول في النموذج
                const totalMods = Object.values(AnalyticsEngine.confidenceTracker.modificationCounts)
                    .reduce((a, b) => a + b, 0);
                const formDuration = Date.now() - AnalyticsEngine.timingSystem.formStartTime;
                
                AnalyticsEngine.effortBalance.measureFormEffort(
                    formInputs.length,
                    formDuration,
                    totalMods
                );
                
                // تقييم التوازن
                const isBalanced = AnalyticsEngine.effortBalance.isBalanced();
                console.log('توازن الجهد:', isBalanced ? 'متوازن' : 'غير متوازن');
                
                updateSummary();
                orderSummary.classList.add('visible');
                confirmBtn.classList.add('visible');
                submitBtn.style.display = 'none';
                
                showMessage('يرجى مراجعة ملخص الطلب أدناه ثم الضغط على "تأكيد و إرسال الطلب"', 'order');
                
                AnalyticsEngine.timingSystem.recordEvent('preview_shown');
                AnalyticsEngine.intentAnalyzer.recordSignal('confirmation_review', 1);
                
                const submitDuration = Date.now() - submitStartTime;
                AnalyticsEngine.connectionQuality.recordResponseTime('form_submit', submitDuration);
                
                setTimeout(() => {
                    orderSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            });
            
            // معالج التأكيد
            confirmBtn.addEventListener('click', function() {
                if (isSubmitting || orderData.isConfirmed) return;
                
                const confirmStartTime = Date.now();
                
                if (checkForLastOrder()) {
                    return;
                }
                
                // كشف التردد قبل التأكيد
                const hasHesitation = AnalyticsEngine.timingSystem.trackConfirmationHesitation(confirmStartTime);
                if (hasHesitation) {
                    console.log('تم اكتشاف تردد قبل التأكيد');
                }
                
                isSubmitting = true;
                orderData.isConfirmed = true;
                confirmBtn.disabled = true;
                showMessage('جاري إرسال طلبك...', 'order');
                
                const formData = {
                    product: orderData.product,
                    price: orderData.price,
                    firstName: document.getElementById('firstName').value.trim(),
                    lastName: document.getElementById('lastName').value.trim(),
                    phone: phoneInput.value.trim(),
                    email: emailInput.value.trim(),
                    city: document.getElementById('city').value.trim(),
                    wilaya: document.getElementById('wilaya').value,
                    message: document.getElementById('message').value.trim(),
                    timestamp: new Date().toISOString()
                };
                
                // تصنيف الاستعجال
                const urgency = AnalyticsEngine.urgencyClassifier.classify({
                    totalTime: Date.now() - AnalyticsEngine.timingSystem.formStartTime,
                    modificationCount: Object.values(AnalyticsEngine.confidenceTracker.modificationCounts)
                        .reduce((a, b) => a + b, 0),
                    hesitationLevel: hasHesitation ? 'high' : 'low'
                });
                
                // إضافة عوامل التنبؤ
                AnalyticsEngine.completionPredictor.addFactor('stability', 
                    AnalyticsEngine.confidenceTracker.stabilityScore, 0.3);
                AnalyticsEngine.completionPredictor.addFactor('timing', 
                    urgency.score, 0.2);
                AnalyticsEngine.completionPredictor.addFactor('intent', 
                    AnalyticsEngine.intentAnalyzer.determineIntent().score, 0.5);
                
                const prediction = AnalyticsEngine.completionPredictor.predict();
                
                setTimeout(() => {
                    console.log('Order submitted:', formData);
                    console.log('Urgency classification:', urgency);
                    console.log('Completion prediction:', prediction);
                    
                    // توليد التقرير الشامل
                    const finalReport = AnalyticsEngine.comprehensiveScoring.generateReport();
                    console.log('Final Analytics Report:', finalReport);
                    
                    localStorage.setItem('lastSuccessfulOrder', Date.now().toString());
                    localStorage.removeItem('selectedProduct');
                    localStorage.removeItem('selectedPrice');
                    localStorage.removeItem('formData');
                    
                    showMessage(`تم استلام طلبك بنجاح! المنتج: ${orderData.product} - ${orderData.price} • سنتواصل معك على الرقم ${formData.phone} خلال 24 ساعة`, 'success');
                    
                    form.reset();
                    orderData.product = '';
                    orderData.price = '';
                    orderData.isConfirmed = false;
                    
                    orderSummary.classList.remove('visible');
                    confirmBtn.classList.remove('visible');
                    submitBtn.style.display = 'block';
                    submitBtn.textContent = 'معاينة الطلب';
                    
                    disableForm();
                    
                    const allCards = document.querySelectorAll('.product-card');
                    allCards.forEach(c => {
                        c.classList.remove('selected');
                        c.querySelector('.product-btn').classList.remove('selected');
                    });
                    
                    isSubmitting = false;
                    confirmBtn.disabled = false;
                    
                    AnalyticsEngine.timingSystem.recordEvent('order_confirmed');
                    AnalyticsEngine.interactionPath.recordStep('order', 'completed');
                }, 1500);
            });
            
            // تحميل الصور الكسولة
            const images = document.querySelectorAll('.product-image img');
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            if (img.dataset.src) {
                                img.src = img.dataset.src;
                                img.removeAttribute('data-src');
                            }
                            observer.unobserve(img);
                        }
                    });
                });
                
                images.forEach(img => imageObserver.observe(img));
            }
            
            // تحذير قبل الخروج
            window.addEventListener('beforeunload', function(e) {
                const hasData = document.getElementById('firstName').value || 
                               phoneInput.value || 
                               document.getElementById('wilaya').value;
                
                if (hasData && !isSubmitting && orderData.product && !checkForLastOrder()) {
                    AnalyticsEngine.interactionPath.recordStep('exit', 'attempted_with_data');
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
            
            // تسجيل دوري للتحليلات (اختياري للمراقبة)
            setInterval(() => {
                const report = AnalyticsEngine.comprehensiveScoring.calculateOverallScore();
                // يمكن إرسال هذا التقرير إلى خادم للتحليل
            }, 30000); // كل 30 ثانية
            
        })();
    </script>
</body>
</html>
